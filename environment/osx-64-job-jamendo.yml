# This environment is setup to run the "job-jamendo". It should also allow
# running and testing demucs pipelines on osx. Unlike the linux environment, we
# specify the pip dependencies here, because there is no local pyproject
# directly associated with the jamendo job.

name: job-jamendo

channels:
  - defaults
  - pytorch
  - conda-forge

dependencies:
  - python=3.9
  - ffmpeg>=4.2,<5
  # demucs uses pytorch 1.8.1 (https://github.com/facebookresearch/demucs/blob/main/environment-cuda.yml)
  # klaypy uses 1.12 (https://github.com/klay-music/klaypy/blob/main/environment/linux-64.yml)
  # conda-linux-64.003-demux uses pytorch 1.12
  - pytorch>=1.12
  - torchaudio>=0.8
  - tqdm>=4.36
  - pip
  - pip:
    - diffq>=0.2
    - dora-search
    - einops
    - hydra-colorlog>=1.1
    - hydra-core>=1.1
    - julius>=0.2.3
    - lameenc>=1.2
    - openunmix
    - musdb>=0.4.0
    - museval>=0.4.0
    - soundfile
    - submitit
    - treetable>=0.2.3
    # I'm going to start by using demucs from klay-beam, but if we end up
    # needing to bundle it directly, here's how we do it:
    # - --editable=git+https://github.com/facebookresearch/demucs.git@2e79e6e#egg=demucs
    - apache-beam[gcp]==2.48
    - -e '../klay_beam[code-style, tests, type-check]'
    - -e '../submodules/klaypy[torch, typing]'
    - -e '../submodules/klay-data[torch, type-check]'
    - -e '../job_jamendo_copy[coda-style, tests, type-check]'